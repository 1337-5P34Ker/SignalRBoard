<!DOCTYPE html>
<html>
<head>

    <style type="text/css">
        .activeCard {
            background: url(/Images/activeCardBackground.png) top left repeat;
        }
    </style>

    <title>SignalR Board</title>
    <!-- Style references -->
    <link rel="stylesheet" href="Content/bootstrap.min.css" />
    <link rel="stylesheet" href="Content/bootstrap-theme.min.css" />
    <link rel="stylesheet" href="Content/font-awesome.min.css"/>
    <link rel="stylesheet" href="Content/styles.min.css" />

    <!--Script references. -->
    <!--Reference the jQuery library. -->
    <script src="Scripts/jquery-2.2.3.min.js"></script>
    <!--Reference the jQuery UI library. -->
    <script src="Scripts/jquery-ui-1.11.4.js"></script>
    <!--Reference the Bootstrap library. -->
    <script src="Scripts/bootstrap.min.js"></script>
    <!--Reference the SignalR library. -->
    <script src="/Scripts/jquery.signalR-2.2.0.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="/signalr/hubs"></script>
</head>
<body>

    <!-- Fixed navbar -->
    <nav class="navbar navbar-inverse navbar-fixed-top">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="#">SignalR Board for Dev 1</a>
            </div>
        </div>
    </nav>


    <div class="container" style="margin-top: 80px">
        <div id="board" class="row"></div>


        <div class="row" id="form" style="margin-top: 50px;">
            <div class="col-md-4">
                <div class="form-group">
                    <label for="title">Titel:</label>
                    <input type="text" id="title" class="form-control" placeholder="Titel" />
                    <input type="hidden" id="cardId" />
                </div>
                <div class="form-group">
                    <label for="description">Beschreibung:</label>
                    <textarea id="description" class="form-control" placeholder="Beschreibung" style="height: 75px"></textarea>
                </div>
                <div class="btn-group" role="group">
                    <input type="button" id="btnSave" value="Add" class="btn btn-default" />
                    <input type="button" id="btnUpdate" value="Update" class="btn btn-default" />
                    <input type="button" id="btnDelete" value="Delete" class="btn btn-default" />
                </div>
                <div class="btn-group" role="group" style="margin-top: 30px">
                    <input type="button" id="btnMoveLeft" value="Left" class="btn btn-default"/>
                    <input type="button" id="btnMoveUp" value="Up" class="btn btn-default"/>
                    <input type="button" id="btnMoveDown" value="Down" class="btn btn-default"/>
                    <input type="button" id="btnMoveRight" value="Right" class="btn btn-default"/>
                </div>
            </div>
        </div>
    </div>
    <!--Add script to update the page and send messages.-->
    <script type="text/javascript">
        var board;
        function getCard(parameters) {
            console.log('cardId: ' + $(parameters).data('cardId'));
            $('#title').val($('.title', parameters).text());
            $('#cardId').val($(parameters).data('cardId'));
            $('#description').val($('.description', parameters).text());
            board.server.GetDirections($('#cardId').val());
            $('.activeCard').removeClass('activeCard');
            $(parameters).addClass('activeCard');
        }


        function handleDragStop(event, ui)
        {
            var card = event.target;
            var cardId = event.target.id;
            var list = $(event.target).closest('.list');
            var listId = list.attr('id');
            var position = $('#' + listId + '>div').index(card);

            console.log('card ID: ' + cardId + '\n list ID: ' + listId + '\n Position ' + position);
            board.server.MoveTo(cardId, listId, position);
        }

        $(function () {
            // Declare a proxy to reference the hub.


            board = $.connection.boardHub;
            // Create a function that the hub can call to broadcast messages.
            board.client.boardMessage = function (message) {
                // Html encode display name and message.
                console.log('boardMessage');
                $('#board').empty();

                $.each(message, function(index, list)
                {
                    var listTemplate = $("<div class='col-md-4'><div class='list'><div class='list-header'></div></div></div>");
                    $('.list-header', listTemplate).text(list.Name);
                    $('.list', listTemplate).attr('id', list.Id);
                   
               
                    $.each(list.Cards, function (index, card) {
                        var cardTemplate = $("<div onclick='getCard(this)' class='card'><h4 class='title'></h4><div class='description'>Dolor sit amet</div>" +
                            "<div class='card-footer'><span class='remove'><i class='fa fa-remove'></i> Löschen</span></div></div>");
                        $('h4', cardTemplate).text(card.Title);
                        $('.description', cardTemplate).text(card.Description);
                        $('span.remove', cardTemplate).on('click', function() { removeCard(card.Id); });
                        $(cardTemplate).data('cardId', card.Id);
                        $(cardTemplate).attr('id', card.Id);

                        //var cardId = '#' + cardId;
                        $('#' + card.Id).remove();
                        $('.list', listTemplate).append(cardTemplate);
                    });
                    $('#board').append(listTemplate);
                });
                var currentCardId = $('#cardId').val();
                $('#' + currentCardId).addClass('activeCard');
                $('.list').sortable();
                $(".list").disableSelection();
                $(".card").draggable({
                    connectToSortable: ".list",
                    revert: "invalid",
                    stop: handleDragStop
                });


            };

            board.client.updateCardMessage = function (message) {
                // Html encode display name and message.
                console.log('updateCardMessage');
                var card = $('#' + message.Id);
                $('.title', card).text(message.Title);
                $('.description', card).text(message.Description);
            };

            board.client.deleteCardMessage = function (cardId) {
                console.log('deleteCardMessage');
                var id = '#' + cardId;
                $(id).remove();
            };

            board.client.directionsMessage = function (message) {
                console.log('getDirectionsMessage');

                $('#btnMoveLeft').prop('disabled', message.indexOf('Left') === -1);
                $('#btnMoveRight').prop('disabled', message.indexOf('Right') === -1);
                $('#btnMoveUp').prop('disabled', message.indexOf('Up') === -1);
                $('#btnMoveDown').prop('disabled', message.indexOf('Down') === -1);

            };

            board.client.activateCardMessage = function (cardId) {
                console.log('activateCardMessage');

                $('.activeCard').removeClass('activeCard');
                $('#' + cardId).addClass('activeCard');

            };



            // Start the connection.
            $.connection.hub.start().done(function () {
                console.log('$.connection.hub.start');
                board.server.Init("boardId"); // ignored

                $('#btnSave').click(function () {
                    // Call the Send method on the hub.
                    board.server.Add($('#title').val(), $('#description').val());
                    // Clear text box and reset focus for next comment.
                    $('#title').val('').focus();
                    $('#description').val('');
                });

                $('#btnUpdate').click(function () {
                    // Call the Update method on the hub.
                    board.server.Update($('#title').val(), $('#description').val(), $('#cardId').val());
                });

                $('#btnDelete').click(function ()
                {
                    removeCard($('#cardId').val());
                });

                $('#btnMoveUp').click(function () {
                    // Call the Update method on the hub.
                    board.server.Move($('#cardId').val(), "Up");
                });

                $('#btnMoveDown').click(function () {
                    // Call the Update method on the hub.
                    board.server.Move($('#cardId').val(), "Down");
                });

                $('#btnMoveRight').click(function () {
                    // Call the Update method on the hub.
                    board.server.Move($('#cardId').val(), "Right");
                });

                $('#btnMoveLeft').click(function () {
                    // Call the Update method on the hub.
                    board.server.Move($('#cardId').val(), "Left");
                });
            });
        });

        function guid() {
            function s4() {
                return Math.floor((1 + Math.random()) * 0x10000)
                  .toString(16)
                  .substring(1);
            }
            return s4() + s4() + '-' + s4() + '-' + s4() + '-' +
              s4() + '-' + s4() + s4() + s4();
        }

        function removeCard(cardId)
        {
            // Call the Delete method on the hub.
            board.server.Delete(cardId);
        }

    </script>
</body>
</html>